---
title: May 2020 Update
order: 1
layout: post
redirect_from: /news/
---

# Handle Response Parsing & Errors better, with less code

_Zapier Developer Platform Team \| May TBD, 2020_

TBD: Intro

## CLI v10.0.0

We shipped a new version of the CLI.  Check out the [changelog](https://github.com/zapier/zapier-platform/blob/master/CHANGELOG.md) and [upgrade]({% link _cli_docs/docs.md %}#updating) your Zapier integration project! This release has several breaking changes, which will be called out here.

## Visual builder

Visual builder apps will be updated to v10 at a later stage and in a way that ensures they won't break. They will then be able to leverage the same changes, including the ability to handle errors and parse content in [`afterResponse` middleware]({% link _cli_docs/docs.md %}#using-http-middleware).

## Error Handling

We've made improvements to help you throw more helpful errors, with less code.

### You can now throw an error with code and status

Since CLI v.9.3.0, you can now throw [`z.errors.Error`]({% link _cli_docs/docs.md %}#zerrors) instead of `Error` and pass an optional string code as second, and number (HTTP) status as third argument. We already use these additional information to link errors in the editor and task history directly to the most relevant troubleshooting docs, and have some ideas for future applications.

![](https://cdn.zappy.app/14dc3a935f7b1a693ba0be3829d4cb88.png)

### We now extract the message from error responses

If you are using visual builder or CLI v9.3.0 or later, [`response.throwForStatus()`]({% link _cli_docs/docs.md %}#http-response-object) will no longer throw messages like `Got 400 calling https://example.com/api, expected 2xx.` but tries to extract an error message *and* code from the response content.

> If your we fail to extract the correct error message, use an `afterResponse` middleware like this:
>
> ```
> if (response.status >= 400 and response.status < 600) {
>   throw z.errors.Error(
>     response.json.errorMessageKey,
>     response.json.errorCodeKey,
>     response.status,
>   );
> }
>
> return response;
> ```

### We now only throw for 4xx and 5xx statuses

Before CLI v10, `response.throwForStatus()` threw for any status above 300. As 3xx statuses are not strictly errors and 600+ aren't valid statuses at all, we now only throw for 4xx and 5xx status codes.

> **BREAKING CHANGE**
>
> If your API may return a 3xx or 600+ status for errors and you relied on `throwForStatus` for throwing on these responses, use an `afterResponse` middleware like this:
>
> ```
> if (response.status > 300) {
>   throw new z.errors.ResponseError(response);
> }
>
> return response;
> ```

### We now throw for error statuses unless you opt-out

Also new in v10 is that [`z.request()`]({% link _cli_docs/docs.md %}#http-request-options) will now call `response.throwForStatus()`, *after* any `afterResponse` middleware you may have defined, and *before* resolving with response. This means that if `response.status` is 4/5xx, an error will be thrown.

Before, you were responsible for calling `throwForStatus()`, either in `afterResponse` middleware or after receiving the `response` from `z.request()`.

> You may now remove any calls to `throwForStatus()`. It can still be useful, e.g. in `afterResponse` middleware to throw early, before you do any custom response parsing (more on that later).

We made this change for the following reasons:

1. For [shorthand]({% link _cli_docs/docs.md %}#shorthand-http-requests) requests, or code-mode as they are called in visual builder, we already did this, with no way to opt out. If you were trying to do custom error handling in `afterResponse` middleware, this could be a problem.
2. If your API follows HTTP status code standards and `throwForStatus()` is able to extract the error message (and code) from the response content, all error handling is taken care off for you.
3. It was easy to forget calling `throwForStatus()`. By making it an opt-out, we hope to reduce cases where error responses were handled as successful ones, leading to errors related to missing fields.

> **BREAKING CHANGE**
>
> If your API may return a 4/5xx status that should not be considered an error, use an `afterResponse` middleware like this:
>
> ```
> const OK = [456, 567];
>
> response.skipThrowForStatus = OK.includes(response.status);
>
> return response;
> ```
>
> You can also opt-out via `z.request({ skipThrowForStatus: true, ... })`. However, we highly recommend using `afterResponse` middleware for custom error handling, and only opt-out those that should not throw an error.

## Response Parsing

In v10 we introduce [`response.data`]({% link _cli_docs/docs.md %}#http-response-object) and deprecate `response.json`. Their value will be the same when `response.content` is JSON, but `data` also supports `application/x-www-form-urlencoded`.

If your API responds with either, you no longer need `querystring.parse()`, just like you already didn't need `(z.)JSON.parse()`. The results will be readily available to you via `response.data`.

> **BREAKING CHANGE**
>
> If you already do custom response parsing in `afterResponse` middleware and set `response.content = JSON.stringify(parsedContent)` in combination with shorthand requests, you will need to change this to `response.data = parsedContent`.
> 
> Before, shorthand requests would ignore `response.json` and try to parse `response.content` as `application/x-www-form-urlencoded` or JSON. We now use `response.data` instead. This means it will no longer pick up on changes to `response.content`.

### Custom Response Parsing

If your API responds with XML or some other format, you can now parse it using an `afterResponse` middleware like:

```
const parser = require('fast-xml-parser');

if ('xml' in response.headers.get('content-type')) {
  response.data = parser(response.content);
}

return response;
```

With no further changes, shorthand requests now work with XML responses and `response.data` can be used without additional parsing after calling `z.request()`.